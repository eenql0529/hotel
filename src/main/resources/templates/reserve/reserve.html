<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">
	
	<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />

<div layout:fragment="content">
	<!-- Breadcrumb Section Begin -->
	<div class="breadcrumb-section">
		<div class="container">
			<div class="row">
				 <input type="hidden" id="typeId" th:value="${rooms.id}"> 
				<div class="col-lg-12">
					<div class="breadcrumb-text">
						<h2>Our Rooms</h2>
						<div class="bt-option">
							<a href="./home.html">Home</a> <span>Rooms</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Breadcrumb Section End -->

	<div class="col-lg-4">
		<div class="room-booking">
			<h3>Your Reservation</h3>
			<form action="#">
				<div class="check-date">
					<label for="date-in">Check In:</label> <input type="text"
						class="date-input" id="date-in"> <i class="icon_calendar"></i>
				</div>
				<div class="check-date">
					<label for="date-out">Check Out:</label> <input type="text"
						class="date-input" id="date-out"> <i class="icon_calendar"></i>
				</div>
				<div class="select-option">
					<label for="guest">Guests:</label> <select id="guest">
						<option value="1">1 Adults</option>
						<option value="2">2 Adults</option>
						<option value="3">3 Adults</option>
					</select>
				</div>

				<button type="submit" onclick="order()">Check Availability</button>
				
											<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}">
			</form>
		</div>

	</div>


</div>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		$(document).ready(function() {
			//처음 상세페이지 화면에 들어올때 총 상품금액이 보여야 하므로
			calculateTotalPrice(); 
			
			//수량 -, + 버튼을 누를때마다 총가격을 구한다
			$(".count_btn").click(function() {
				calculateTotalPrice();
			})
		});
		
		function calculateTotalPrice() {
			var count = $("#count").val(); //수량
			var price = $("#price").val(); //가격
			var totalPrice = (price * count).toLocaleString('ko-KR'); //천단위 콤마
			$("#totalPrice").html(totalPrice + '원'); //총가격 출력
		}
		
		function order() {
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			
			var url = "/reservation";
			
			//controller(서버)에 전달할 데이터
			var paramData = {
					itemId : $("#itemId").val(), //item의 id
					count: $("#count").val() //수량
			}
			
			//★전달하기 전에 데이터를 반드시 JSON -> 문자열로 만들어야 한다.
			var param = JSON.stringify(paramData);
			
			$.ajax({
				url : url, //request URL
				type : "POST", //전송방식
				contentType : "application/json",
				data : param, //서버에 전송할 데이터
				beforeSend : function(xhr) {
					//데이터를 전송하기전에 헤더에 csrf 값을 설정
					xhr.setRequestHeader(header, token);
				},
				dataType : "json",
				cache : false,
				success : function(result, status) {
					alert("주문이 완료 되었습니다." + result);
					//location.href = '/';
				},
				error : function(jqXHR, status, error) {
					if (jqXHR.status == '401') {
						alert('로그인 후 이용해주세요.');
						location.href = '/members/login';
					} else {
						//에러메세지 출력(ResponseEntity에서 받아온 값을 출력해준다)
						alert(jqXHR.responseText); 
					}
				}
			});
			
		}
	</script>
</th:block>
</html>